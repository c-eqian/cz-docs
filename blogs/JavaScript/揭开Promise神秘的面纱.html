<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>揭开Promise神秘的面纱 | 秋谨~</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="https://s3.uuu.ovh/imgs/2022/11/23/f0fcebdd69e0360a.jpeg">
    <script language="javascript" type="text/javascript" src="https://cdn.staticfile.org/jquery/1.7.2/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/cz-docs/js/MouseClickEffect.js"></script>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/cz-docs/assets/css/0.styles.f183d118.css" as="style"><link rel="preload" href="/cz-docs/assets/js/app.e0426d90.js" as="script"><link rel="preload" href="/cz-docs/assets/js/4.f75cd3a5.js" as="script"><link rel="preload" href="/cz-docs/assets/js/1.0d7da4e9.js" as="script"><link rel="preload" href="/cz-docs/assets/js/17.6c17d3eb.js" as="script"><link rel="preload" href="/cz-docs/assets/js/11.a973ada2.js" as="script"><link rel="prefetch" href="/cz-docs/assets/js/10.dfa5009c.js"><link rel="prefetch" href="/cz-docs/assets/js/12.17f2b6eb.js"><link rel="prefetch" href="/cz-docs/assets/js/13.446c18cf.js"><link rel="prefetch" href="/cz-docs/assets/js/14.319035df.js"><link rel="prefetch" href="/cz-docs/assets/js/15.e58df88e.js"><link rel="prefetch" href="/cz-docs/assets/js/16.bcd871df.js"><link rel="prefetch" href="/cz-docs/assets/js/18.3188b422.js"><link rel="prefetch" href="/cz-docs/assets/js/19.cf63a7dc.js"><link rel="prefetch" href="/cz-docs/assets/js/2.af67ce17.js"><link rel="prefetch" href="/cz-docs/assets/js/20.e96e1c8c.js"><link rel="prefetch" href="/cz-docs/assets/js/21.c3506834.js"><link rel="prefetch" href="/cz-docs/assets/js/22.8d57a774.js"><link rel="prefetch" href="/cz-docs/assets/js/23.e02511b2.js"><link rel="prefetch" href="/cz-docs/assets/js/24.95581d2b.js"><link rel="prefetch" href="/cz-docs/assets/js/25.bfa5c2a4.js"><link rel="prefetch" href="/cz-docs/assets/js/26.a81c727e.js"><link rel="prefetch" href="/cz-docs/assets/js/27.5e8493f4.js"><link rel="prefetch" href="/cz-docs/assets/js/28.bbb6a756.js"><link rel="prefetch" href="/cz-docs/assets/js/29.cbfad1cf.js"><link rel="prefetch" href="/cz-docs/assets/js/30.7e4a45f7.js"><link rel="prefetch" href="/cz-docs/assets/js/31.2fe318d6.js"><link rel="prefetch" href="/cz-docs/assets/js/32.bdfcc26f.js"><link rel="prefetch" href="/cz-docs/assets/js/33.521f162d.js"><link rel="prefetch" href="/cz-docs/assets/js/34.d9c77f24.js"><link rel="prefetch" href="/cz-docs/assets/js/35.269212cc.js"><link rel="prefetch" href="/cz-docs/assets/js/36.e7a6ea87.js"><link rel="prefetch" href="/cz-docs/assets/js/37.1fca32fb.js"><link rel="prefetch" href="/cz-docs/assets/js/38.61314264.js"><link rel="prefetch" href="/cz-docs/assets/js/39.816c493d.js"><link rel="prefetch" href="/cz-docs/assets/js/5.36e7918c.js"><link rel="prefetch" href="/cz-docs/assets/js/6.e2e6a695.js"><link rel="prefetch" href="/cz-docs/assets/js/7.3816eded.js"><link rel="prefetch" href="/cz-docs/assets/js/8.b74c6eeb.js"><link rel="prefetch" href="/cz-docs/assets/js/9.2bd2cb8d.js">
    <link rel="stylesheet" href="/cz-docs/assets/css/0.styles.f183d118.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-58d791b2><div data-v-58d791b2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-08f61db9 data-v-58d791b2 data-v-58d791b2><h3 class="title" data-v-08f61db9>秋谨~</h3> <p class="description" data-v-08f61db9></p> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>秋谨</span>
          
        <span data-v-08f61db9>2022 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-58d791b2><header class="navbar" data-v-58d791b2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/cz-docs/" class="home-link router-link-active"><img src="https://s3.bmp.ovh/imgs/2022/12/21/0aedf538ece60a2f.png" alt="秋谨~" class="logo"> <span class="site-name">秋谨~</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/cz-docs/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      文档
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://c-eqian.github.io/co-utils-vue/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  @eqian/utils-vue工具库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://c-eqian.github.io/e-plus-ui/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  e-plus-ui组件库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/cz-docs/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      笔记
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cz-docs/categories/vue/" class="nav-link"><i class="undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/JavaScript/" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/其他/" class="nav-link"><i class="undefined"></i>
  其他
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/SQL/" class="nav-link"><i class="undefined"></i>
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/react/" class="nav-link"><i class="undefined"></i>
  react
</a></li></ul></div></div><div class="nav-item"><a href="/cz-docs/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="https://www.eqian.site/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-date"></i>
  个人网站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-58d791b2></div> <aside class="sidebar" data-v-58d791b2><div class="personal-info-wrapper" data-v-dd0a4f6c data-v-58d791b2><img src="https://s3.bmp.ovh/imgs/2022/11/23/f0fcebdd69e0360a.jpeg" alt="author-avatar" class="personal-img" data-v-dd0a4f6c> <h3 class="name" data-v-dd0a4f6c>
    秋谨
  </h3> <div class="num" data-v-dd0a4f6c><div data-v-dd0a4f6c><h3 data-v-dd0a4f6c>26</h3> <h6 data-v-dd0a4f6c>文章</h6></div> <div data-v-dd0a4f6c><h3 data-v-dd0a4f6c>25</h3> <h6 data-v-dd0a4f6c>标签</h6></div></div> <ul class="social-links" data-v-dd0a4f6c></ul> <hr data-v-dd0a4f6c></div> <nav class="nav-links"><div class="nav-item"><a href="/cz-docs/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      文档
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://c-eqian.github.io/co-utils-vue/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  @eqian/utils-vue工具库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://c-eqian.github.io/e-plus-ui/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  e-plus-ui组件库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/cz-docs/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      笔记
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cz-docs/categories/vue/" class="nav-link"><i class="undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/JavaScript/" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/其他/" class="nav-link"><i class="undefined"></i>
  其他
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/SQL/" class="nav-link"><i class="undefined"></i>
  SQL
</a></li><li class="dropdown-item"><!----> <a href="/cz-docs/categories/react/" class="nav-link"><i class="undefined"></i>
  react
</a></li></ul></div></div><div class="nav-item"><a href="/cz-docs/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><a href="https://www.eqian.site/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-date"></i>
  个人网站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-08f61db9 data-v-58d791b2><h3 class="title" data-v-08f61db9>揭开Promise神秘的面纱</h3> <!----> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>秋谨</span>
          
        <span data-v-08f61db9>2022 - </span>
        2024
      </a></span></div></div> <div data-v-58d791b2><div data-v-58d791b2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">揭开Promise神秘的面纱</h1> <div data-v-ea9cd536><i class="iconfont reco-account" data-v-ea9cd536><span data-v-ea9cd536>秋谨</span></i> <i class="iconfont reco-date" data-v-ea9cd536><span data-v-ea9cd536></span></i> <!----> <i class="tags iconfont reco-tag" data-v-ea9cd536><span class="tag-item" data-v-ea9cd536>JavaScript</span></i></div></div> <div class="theme-reco-content content__default"><blockquote><p>山有木兮木有枝，心悦君兮君不知</p></blockquote> <p>一个让人疯狂的 <code>Promise</code> 就像是在玩一场心跳加速的俄罗斯轮盘赌——你永远不知道它下一秒是会优雅地 <code>resolve</code> 还是突然 <code>reject</code>。这不，刚写的那个 <code>Promise</code>，不仅自己玩起了捉迷藏，还顺便把我的耐心也给藏起来了。每次我满怀期待地用 <code>.then</code> 去迎接它的成功，结果它却总是在最后一刻跳转到 <code>.catch</code>，留下一句：“哈哈，你又上当了！”仿佛在说：“程序员，来追我呀！”搞得我每次调试都得先深呼吸三次，才能鼓起勇气去面对那行熟悉的 <code>console.error</code>。</p> <p>开玩笑、开玩笑、开玩笑，还是回归正题吧</p> <p>接下来让我们一起去探索<code>Promise</code>那神秘的面纱，激动的心，颤抖的手，就像是在解开新娘的红盖头。哈哈哈哈哈哈哈哈<img src="https://dl4.weshineapp.com/gif/20221201/efacec6a1813b487e11d813df014ae19.gif?f=micro_" alt="img"></p> <p><strong>以下关于promise/A+规范的译文<a href="https://www.ituring.com.cn/article/66566#note-1" target="_blank" rel="noopener noreferrer">翻译来自<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></p> <h1 id="术语"><a href="#术语" class="header-anchor">#</a> 术语</h1> <hr> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <p>promise 是一个拥有 <code>then</code> 方法的对象或函数，其行为符合本规范；</p> <h2 id="thenable"><a href="#thenable" class="header-anchor">#</a> thenable</h2> <p>是一个定义了 <code>then</code> 方法的对象或函数，文中译作“拥有 <code>then</code> 方法”；</p> <h2 id="值-value"><a href="#值-value" class="header-anchor">#</a> 值（value）</h2> <p>指任何 JavaScript 的合法值（包括 <code>undefined</code> , thenable 和 promise）；</p> <h2 id="异常-exception"><a href="#异常-exception" class="header-anchor">#</a> 异常（exception）</h2> <p>是使用 <code>throw</code> 语句抛出的一个值。</p> <h2 id="拒因-reason"><a href="#拒因-reason" class="header-anchor">#</a> 拒因（reason）</h2> <p>表示一个 promise 的拒绝原因。</p> <h1 id="要求"><a href="#要求" class="header-anchor">#</a> 要求</h1> <hr> <h2 id="promise-的状态"><a href="#promise-的状态" class="header-anchor">#</a> Promise 的状态</h2> <p>一个 Promise 的当前状态必须为以下三种状态中的一种：<strong>等待态（Pending）</strong>、<strong>执行态（Fulfilled）和拒绝态（Rejected）</strong>。</p> <h3 id="等待态-pending"><a href="#等待态-pending" class="header-anchor">#</a> 等待态（Pending）</h3> <p>处于等待态时，promise 需满足以下条件：</p> <ul><li>可以迁移至执行态或拒绝态</li></ul> <h3 id="执行态-fulfilled"><a href="#执行态-fulfilled" class="header-anchor">#</a> 执行态（Fulfilled）</h3> <p>处于执行态时，promise 需满足以下条件：</p> <ul><li>不能迁移至其他任何状态</li> <li>必须拥有一个<strong>不可变</strong>的终值</li></ul> <h3 id="拒绝态-rejected"><a href="#拒绝态-rejected" class="header-anchor">#</a> 拒绝态（Rejected）</h3> <p>处于拒绝态时，promise 需满足以下条件：</p> <ul><li>不能迁移至其他任何状态</li> <li>必须拥有一个<strong>不可变</strong>的据因</li></ul> <p>这里的不可变指的是恒等（即可用 <code>===</code> 判断相等），而不是意味着更深层次的不可变（指当 value 或 reason 不是基本值时，只要求其引用地址相等，但属性值可被更改）。</p> <h2 id="then-方法"><a href="#then-方法" class="header-anchor">#</a> <strong>Then 方法</strong></h2> <p>一个 promise 必须提供一个 <code>then</code> 方法以访问其当前值、终值和拒因。</p> <p>promise 的 <code>then</code> 方法接受两个参数：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>promise.then(onFulfilled, onRejected)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="参数可选"><a href="#参数可选" class="header-anchor">#</a> 参数可选</h3> <p><code>onFulfilled</code> 和 <code>onRejected</code> 都是可选参数。</p> <ul><li>如果 <code>onFulfilled</code> 不是函数，其必须被忽略</li> <li>如果 <code>onRejected</code> 不是函数，其必须被忽略</li></ul> <h3 id="onfulfilled-特性"><a href="#onfulfilled-特性" class="header-anchor">#</a> <code>onFulfilled</code> 特性</h3> <p>如果 <code>onFulfilled</code> 是函数：</p> <ul><li>当 <code>promise</code> 执行结束后其必须被调用，其第一个参数为 <code>promise</code> 的终值</li> <li>在 <code>promise</code> 执行结束前其不可被调用</li> <li>其调用次数不可超过一次</li></ul> <h3 id="onrejected-特性"><a href="#onrejected-特性" class="header-anchor">#</a> <code>onRejected</code> 特性</h3> <p>如果 <code>onRejected</code> 是函数：</p> <ul><li>当 <code>promise</code> 被拒绝执行后其必须被调用，其第一个参数为 <code>promise</code> 的据因</li> <li>在 <code>promise</code> 被拒绝执行前其不可被调用</li> <li>其调用次数不可超过一次</li></ul> <h3 id="调用时机"><a href="#调用时机" class="header-anchor">#</a> 调用时机</h3> <p><code>onFulfilled</code> 和 <code>onRejected</code> 只有在<a href="http://es5.github.io/#x10.3" target="_blank" rel="noopener noreferrer">执行环境<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>堆栈仅包含<strong>平台代码</strong>时才可被调用 <a href="https://www.ituring.com.cn/article/66566#note-1" target="_blank" rel="noopener noreferrer">注1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="调用要求"><a href="#调用要求" class="header-anchor">#</a> 调用要求</h3> <p><code>onFulfilled</code> 和 <code>onRejected</code> 必须被作为函数调用（即没有 <code>this</code> 值）[注2][2]</p> <h3 id="多次调用"><a href="#多次调用" class="header-anchor">#</a> 多次调用</h3> <p><code>then</code> 方法可以被同一个 <code>promise</code> 调用多次</p> <ul><li>当 <code>promise</code> 成功执行时，所有 <code>onFulfilled</code> 需按照其注册顺序依次回调</li> <li>当 <code>promise</code> 被拒绝执行时，所有的 <code>onRejected</code> 需按照其注册顺序依次回调</li></ul> <h3 id="返回"><a href="#返回" class="header-anchor">#</a> 返回</h3> <p><code>then</code> 方法必须返回一个 <code>promise</code> 对象 [注3][3]</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>promise2 = promise1.then(onFulfilled, onRejected);   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>如果 <code>onFulfilled</code> 或者 <code>onRejected</code> 返回一个值 <code>x</code> ，则运行下面的 <strong>Promise 解决过程</strong>：<code>[[Resolve]](promise2, x)</code></li> <li>如果 <code>onFulfilled</code> 或者 <code>onRejected</code> 抛出一个异常 <code>e</code> ，则 <code>promise2</code> 必须拒绝执行，并返回拒因 <code>e</code></li> <li>如果 <code>onFulfilled</code> 不是函数且 <code>promise1</code> 成功执行， <code>promise2</code> 必须成功执行并返回相同的值</li> <li>如果 <code>onRejected</code> 不是函数且 <code>promise1</code> 拒绝执行， <code>promise2</code> 必须拒绝执行并返回相同的据因</li></ul> <p>**译者注：**理解上面的“返回”部分非常重要，即：<strong>不论 <code>promise1</code> 被 reject 还是被 resolve 时 <code>promise2</code> 都会被 resolve，只有出现异常时才会被 rejected</strong>。</p> <h2 id="promise-解决过程"><a href="#promise-解决过程" class="header-anchor">#</a> <strong>Promise 解决过程</strong></h2> <p><strong>Promise 解决过程</strong>是一个抽象的操作，其需输入一个 <code>promise</code> 和一个值，我们表示为 <code>[[Resolve]](promise, x)</code>，如果 <code>x</code> 有 <code>then</code> 方法且看上去像一个 Promise ，解决程序即尝试使 <code>promise</code> 接受 <code>x</code> 的状态；否则其用 <code>x</code> 的值来执行 <code>promise</code> 。</p> <p>这种 <em>thenable</em> 的特性使得 Promise 的实现更具有通用性：只要其暴露出一个遵循 Promise/A+ 协议的 <code>then</code> 方法即可；这同时也使遵循 Promise/A+ 规范的实现可以与那些不太规范但可用的实现能良好共存。</p> <p>运行 <code>[[Resolve]](promise, x)</code> 需遵循以下步骤：</p> <h3 id="x-与-promise-相等"><a href="#x-与-promise-相等" class="header-anchor">#</a> <code>x</code> 与 <code>promise</code> 相等</h3> <p>如果 <code>promise</code> 和 <code>x</code> 指向同一对象，以 <code>TypeError</code> 为据因拒绝执行 <code>promise</code></p> <h3 id="x-为-promise"><a href="#x-为-promise" class="header-anchor">#</a> <code>x</code> 为 Promise</h3> <p>如果 <code>x</code> 为 Promise ，则使 <code>promise</code> 接受 <code>x</code> 的状态 [注4][4]：</p> <ul><li>如果 <code>x</code> 处于等待态， <code>promise</code> 需保持为等待态直至 <code>x</code> 被执行或拒绝</li> <li>如果 <code>x</code> 处于执行态，用相同的值执行 <code>promise</code></li> <li>如果 <code>x</code> 处于拒绝态，用相同的据因拒绝 <code>promise</code></li></ul> <h3 id="x-为对象或函数"><a href="#x-为对象或函数" class="header-anchor">#</a> <code>x</code> 为对象或函数</h3> <p>如果 <code>x</code> 为对象或者函数：</p> <ul><li>把 <code>x.then</code> 赋值给 <code>then</code> [注5][5]</li> <li>如果取 <code>x.then</code> 的值时抛出错误 <code>e</code> ，则以 <code>e</code> 为据因拒绝 <code>promise</code></li> <li>如果<code>then</code>是函数，将<code>x</code>作为函数的作用域this调用之。传递两个回调函数作为参数，第一个参数叫做<code>resolvePromise</code>，第二个参数叫做<code>rejectPromise</code>:
<ul><li>如果 <code>resolvePromise</code> 以值 <code>y</code> 为参数被调用，则运行 <code>[[Resolve]](promise, y)</code></li> <li>如果 <code>rejectPromise</code> 以据因 <code>r</code> 为参数被调用，则以据因 <code>r</code> 拒绝 <code>promise</code></li> <li>如果 <code>resolvePromise</code> 和 <code>rejectPromise</code> 均被调用，或者被同一参数调用了多次，则优先采用首次调用并忽略剩下的调用</li> <li>如果调用<code>then</code>方法抛出了异常<code>e</code>：
<ul><li>如果 <code>resolvePromise</code> 或 <code>rejectPromise</code> 已经被调用，则忽略之</li> <li>否则以 <code>e</code> 为据因拒绝 <code>promise</code></li></ul></li> <li>如果 <code>then</code> 不是函数，以 <code>x</code> 为参数执行 <code>promise</code></li></ul></li> <li>如果 <code>x</code> 不为对象或者函数，以 <code>x</code> 为参数执行 <code>promise</code></li></ul> <p>如果一个 promise 被一个循环的 <em>thenable</em> 链中的对象解决，而 <code>[[Resolve]](promise, thenable)</code> 的递归性质又使得其被再次调用，根据上述的算法将会陷入无限递归之中。算法虽不强制要求，但也鼓励施者检测这样的递归是否存在，若检测到存在则以一个可识别的 <code>TypeError</code> 为据因来拒绝 <code>promise</code> [注6][6]。</p> <h1 id="注释"><a href="#注释" class="header-anchor">#</a> 注释</h1> <hr> <ul><li><p><strong>注1</strong> 这里的<strong>平台代码</strong>指的是引擎、环境以及 promise 的实施代码。实践中要确保 <code>onFulfilled</code> 和 <code>onRejected</code> 方法异步执行，且应该在 <code>then</code> 方法被调用的那一轮事件循环之后的新执行栈中执行。这个事件队列可以采用“宏任务（macro-task）”机制或者“微任务（micro-task）”机制来实现。由于 promise 的实施代码本身就是平台代码（**译者注：**即都是 JavaScript），故代码自身在处理在处理程序时可能已经包含一个任务调度队列。</p> <p>**译者注：**这里提及了 macrotask 和 microtask 两个概念，这表示异步任务的两种分类。在挂起任务时，JS 引擎会将所有任务按照类别分到这两个队列中，首先在 macrotask 的队列（这个队列也被叫做 task queue）中取出第一个任务，执行完毕后取出 microtask 队列中的所有任务顺序执行；之后再取 macrotask 任务，周而复始，直至两个队列的任务都取完。</p> <p>两个类别的具体分类如下：</p> <ul><li><strong>macro-task:</strong> script（整体代码）, <code>setTimeout</code>, <code>setInterval</code>, <code>setImmediate</code>, I/O, UI rendering</li> <li><strong>micro-task:</strong> <code>process.nextTick</code>, <code>Promises</code>（这里指浏览器实现的原生 Promise）, <code>Object.observe</code>, <code>MutationObserver</code></li></ul> <p>详见 <a href="http://stackoverflow.com/questions/25915634/difference-between-microtask-and-macrotask-within-an-event-loop-context" target="_blank" rel="noopener noreferrer">stackoverflow 解答<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或 <a href="http://wengeezhang.com/?p=11" target="_blank" rel="noopener noreferrer">这篇博客<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><strong>注2</strong> 也就是说在**严格模式（strict）**中，函数 <code>this</code> 的值为 <code>undefined</code> ；在非严格模式中其为全局对象。</p></li> <li><p><strong>注3</strong> 代码实现在满足所有要求的情况下可以允许 <code>promise2 === promise1</code> 。每个实现都要文档说明其是否允许以及在何种条件下允许 <code>promise2 === promise1</code> 。</p></li> <li><p><strong>注4</strong> 总体来说，如果 <code>x</code> 符合当前实现，我们才认为它是真正的 <em>promise</em> 。这一规则允许那些特例实现接受符合已知要求的 Promises 状态。</p></li> <li><p><strong>注5</strong> 这步我们先是存储了一个指向 <code>x.then</code> 的引用，然后测试并调用该引用，以避免多次访问 <code>x.then</code> 属性。这种预防措施确保了该属性的一致性，因为其值可能在检索调用时被改变。</p></li> <li><p><strong>注6</strong> 实现不应该对 <em>thenable</em> 链的深度设限，并假定超出本限制的递归就是无限循环。只有真正的循环递归才应能导致 <code>TypeError</code> 异常；如果一条无限长的链上 <em>thenable</em> 均不相同，那么递归下去永远是正确的行为。</p></li></ul> <h1 id="代码过程"><a href="#代码过程" class="header-anchor">#</a> 代码过程</h1> <h2 id="创建promise实例"><a href="#创建promise实例" class="header-anchor">#</a> 创建<code>promise</code>实例</h2> <p>根据原生的<code>Promise</code>使用方法我们都知道，<code>Promise</code>接收一个参数函数<code>executor</code>,包含了两个方法<code>resolve</code>、<code>reject</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>因此我们为了简化代码可以使用ES6语法，创建一个<code>CrazyPromise</code>类，根据以上译文，一个promise具有三种状态，待定（<code>pending</code>）、已成功（<code>fulfilled</code>）、已拒绝（<code>reject</code>），在初始时，设定为一个待定状态</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">{</span>
    <span class="token comment">// 定义三种状态</span>
    <span class="token keyword">static</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span> <span class="token comment">// 待定状态</span>
    <span class="token keyword">static</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span> <span class="token comment">// 已拒绝</span>
    <span class="token keyword">static</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span> <span class="token comment">// 已成功</span>
    <span class="token comment">/**
     * 接收一个执行器，具有两个参数，已成功（resolve）、已拒绝（reject）
     * @param executor
     */</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/**
         * 定义初始状态的结果，因为在实例创建的时候，由于必须有一个执行状态的返回结果，要么成功要么拒绝
         * 成功（resolve）时将结果保存到value中，已拒绝时（reject）将原因保存到value中
         * @type {null}
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span> <span class="token comment">// 初始为待定（pending）</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 将已成功执行的方法（resolve）和已拒绝的方法（reject）作为参数传入executor方法
             * 注意这里this指向问题，因为在resolve和reject中会使用当前实例的this，如果不将当前实例的this，绑定到resolve或者reject中
             * 在使用者使用resolve或者reject时，由于是在当前实例外部使用
             * 所以this指向将会丢失，会指向window环境
             * 注意： 这里可能会在执行方法里边有异常出现，应该要捕获异常并看做已拒绝（reject）
             */</span>
            <span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 定义一个resolve方法
     */</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 定义一个reject方法
     */</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>以上代码有两点需要注意的地方：</p> <ul><li>暴露出去resolve和reject中会使用当前实例的this（后面会讲到），如果不将this指向它们，那么在外部使用的时候，将会丢失</li> <li>使用异常捕获，因为由于在执行代码里面可能会出现异常，因此需要将其捕获并作为reject返回</li></ul> <h2 id="resolve方法"><a href="#resolve方法" class="header-anchor">#</a> resolve方法</h2> <p>接下来就是实现resolve的相关逻辑。一个promise的结果要么是成功的（resolve）、要么是拒绝的，也就是失败的结果（reject），而且根据状态，只有在待定（pending）的状态，才能变更状态值，因此，实现的代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">/**
     * 定义一个resolve方法
     * 接收一个结果值参数
     */</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 只有待定的（pending）状态下，才可以变更</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 修改状态为成功的（fulfilled）</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存结果</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="reject方法"><a href="#reject方法" class="header-anchor">#</a> reject方法</h2> <p>reject的方法实现过程与resolve几乎一致，代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">/**
     * 定义一个reject方法
     * 接收一个拒因的结果
     */</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 只有待定的（pending）状态下，才可以变更</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 修改状态为拒绝的（rejected）</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存结果</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="then方法"><a href="#then方法" class="header-anchor">#</a> then方法</h2> <ul><li><code>then</code>是执行结果的回调，接受两个参数，参数状态只能够执行一个，要么成功（<code>onFulfilled</code>）的要么失败的(<code>onRejected</code>)</li> <li>因为then方法必须返回一个promise，因此需要在基础上创建一个promise对象</li> <li><strong>then方法是整个promise的核心，会稍微比较复杂，逻辑也比较不易上手，建议根据规范上手</strong></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">/**
     * 接受两个参数，参数状态只能够执行一个，要么成功的要么失败的
     * @param onFulfilled resolve时返回的结果回调
     * @param onRejected reject时返回的结果回调
     */</span>
    <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/**
         * 因为then方法必须返回一个promise，因此需要在基础上创建一个promise对象
         */</span>
        <span class="token keyword">const</span> promise <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> promise <span class="token comment">// 返回一个promise</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li><p>在then方法执行的时候，因为是异步的，所以需要添加一个具有异步执行的任务，可以使用<code>setTimeout</code>（宏任务），或者<code>queueMicrotask</code>(微任务)，这里使用后者</p></li> <li><p>then方法执行的回调，必须是状态为已成功的（resolve）或者已拒绝的（reject）二选其一，因此需要做一下判断处理</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>        <span class="token comment">/**
         * 因为then方法必须返回一个promise，因此需要在基础上创建一个promise对象
         */</span>
        <span class="token keyword">const</span> promise <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 判断当前的状态是不是成功的（fulfilled）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 将每个执行回调使用微任务包裹起来</span>
                <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                    <span class="token comment">// 因为then的执行回调可能是onFulfilled或者onRejected的，所以我们需要判断需要处理的回调是什么</span>
                    <span class="token comment">// 判断 onFulfilled回调是不是一个函数，如果不是，那么默认处理状态为resolve</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 如果 `onFulfilled` 或者 `onRejected` 抛出一个异常 `e` ，则 `promise2` 必须拒绝执行，并返回拒因 `e`</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">//     执行onFulfilled获取结果x,根据规范，该值可能是promise或者对象或者函数</span>
                            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">/**
                             * 解析promise过程
                             * 这里需要一个解析resolve或者reject的结果值
                             */</span>
                            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 当前的执行结果</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/**
 * 处理拿到的结果值，然后递归去解析，直到拿到最外层的值，可以理解为基础数据类型
 * @param promise 由then 返回的promise
 * @param x 执行成功或者失败回调函数得到的值，根据规范，该值可能是promise或者对象或者函数
 * @param resolve
 * @param reject
 */</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><ul><li><p>不管是resolve或者是reject的状态，它们的逻辑效果几乎一致的，因此在需要判断reject状态下的执行回调</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>      <span class="token comment">// 又或者是不是失败的（reject）</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 将每个执行回调使用微任务包裹起来</span>
                <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                    <span class="token comment">// 因为then的执行回调可能是onFulfilled或者onRejected的，所以我们需要判断需要处理的回调是什么</span>
                    <span class="token comment">// 这里返回一个对象的形式，一个键是onFulfilled，表示需要执行成功的回调，一个是onRejected表示执行失败的回调</span>
                    <span class="token comment">// 判断 onRejected回调是不是一个函数，如果不是，那么默认处理状态为reject</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 如果 `onFulfilled` 或者 `onRejected` 抛出一个异常 `e` ，则 `promise2` 必须拒绝执行，并返回拒因 `e`</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">//     执行onFulfilled获取结果x,根据规范，该值可能是promise或者对象或者函数</span>
                            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">/**
                             * 解析promise过程
                             * 这里需要一个解析resolve或者reject的结果值
                             */</span>
                            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 当前的执行结果</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></li></ul> <p><strong>这里需要特别注意</strong></p> <ul><li><p>因为可能是待定的（pending）， 这里为什么会是待定的呢，因为在没有resolve时，可能已经执行到这里来了，而且，then方法是异步的，需要等待resolve或者reject完成，才能执行then的后续代码；而且，如果是执行了多个then（比如链式）的方法是依次执行的，同时，根据队列的关系先进先出原则，我们可以使用数组将其保存起来，待resolve完成后，我们再去执行。所以这里我们需要创建一个数组``tasks<code>。最终完整的</code>constructor`初始化代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">/**
     * 接收一个执行器，具有两个参数，已成功（resolve）、已拒绝（reject）
     * @param executor
     */</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/**
         * 定义初始状态的结果，因为在实例创建的时候，由于必须有一个执行状态的返回结果，要么成功要么拒绝
         * 成功（resolve）时将结果保存到value中，已拒绝时（reject）将原因保存到value中
         * @type {null}
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 创建一个任务队列，保存在then方法中回调的代码</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 将已成功执行的方法（resolve）和已拒绝的方法（reject）作为参数传入executor方法
             * 注意这里this指向问题，因为在resolve和reject中会使用当前实例的this，如果不将当前实例的this，绑定到resolve或者reject中
             * 在使用者使用resolve或者reject时，由于是在当前实例外部使用
             * 所以this指向将会丢失，会指向window环境
             * 注意： 这里可能会在执行方法里边有异常出现，应该要捕获异常并看做已拒绝（reject）
             */</span>
            <span class="token function">executor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></li> <li><p>处理待定（pending）状态</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/**
 * 但是，又因为可能是待定的（pending）， 这里为什么会是待定的呢，因为在没有resolve时，
 * 可能已经执行到这里来了，而且，then方法是异步的，需要等待resolve或者reject完成，才能执行then的后续代码
 * 而且，如果是执行了多个then（比如链式）的方法是依次执行的
 * 同时，根据队列的关系先进先出原则，我们可以使用数组将其保存起来，待resolve完成后，我们再去执行
 * 既然知道then方法是异步的，那么怎么去实现异步的方式呢，可以使用setTimeout（宏任务），或者queueMicrotask(微任务)，这里使用后者
 */</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function-variable function">onFulfilled</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将每个执行回调使用微任务包裹起来</span>
            <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token comment">// 因为then的执行回调可能是onFulfilled或者onRejected的，所以我们需要判断需要处理的回调是什么</span>
                <span class="token comment">// 这里返回一个对象的形式，一个键是onFulfilled，表示需要执行成功的回调，一个是onRejected表示执行失败的回调</span>
                <span class="token comment">// 判断 onFulfilled回调是不是一个函数，如果不是，那么默认处理状态为resolve</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 如果 `onFulfilled` 或者 `onRejected` 抛出一个异常 `e` ，则 `promise2` 必须拒绝执行，并返回拒因 `e`</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">//     执行onFulfilled获取结果x,根据规范，该值可能是promise或者对象或者函数</span>
                        <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">/**
                         * 解析promise过程
                         * 这里需要一个解析resolve或者reject的结果值
                         */</span>
                        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 当前的执行结果</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">//   同onFulfilled</span>
      <span class="token function-variable function">onRejected</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 将每个执行回调使用微任务包裹起来</span>
          <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
              <span class="token comment">// 因为then的执行回调可能是onFulfilled或者onRejected的，所以我们需要判断需要处理的回调是什么</span>
              <span class="token comment">// 这里返回一个对象的形式，一个键是onFulfilled，表示需要执行成功的回调，一个是onRejected表示执行失败的回调</span>
              <span class="token comment">// 判断 onFulfilled回调是不是一个函数，如果不是，那么默认处理状态为resolve</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 如果 `onFulfilled` 或者 `onRejected` 抛出一个异常 `e` ，则 `promise2` 必须拒绝执行，并返回拒因 `e`</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{</span>
                      <span class="token comment">//     执行onFulfilled获取结果x,根据规范，该值可能是promise或者对象或者函数</span>
                      <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token comment">/**
                       * 解析promise过程
                       */</span>
                      <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                  <span class="token punctuation">}</span>

              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token comment">// 当前的执行结果</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div></li></ul></li> <li><p>实现<code>resolvePromise</code>的过程解析：</p> <ul><li>判断<code>x</code>是否与<code>promise</code>为同一个引用,如果是，抛出异常</li> <li>判断<code>x</code>是否为一个<code>promise</code>，如果是，那么再去执行x的then方法，并将成功的结果<code>y</code>,再次尝试去递归解析</li> <li>如果是一个对象或者函数，尝试去取其then方法
<ul><li>如果可以取到then，再判断是不是一个函数，如果是一个函数，那么将<code>x</code>作为then的this指向，去调用，同时需要同上一步一样，去递归解析</li> <li>如果不是一个函数，那么执行resolve结果</li></ul></li> <li>如果在取的过程中抛出异常，那么要以<code>e</code>为拒因reject出去</li> <li>最后，如果x既不是对象也不是函数也不是promise，那么resolve结果</li></ul></li> <li><p><strong>最后<code>resolvePromise</code>完整代码如下：</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/**
 * 处理拿到的结果值，然后递归去解析，直到拿到最外层的值，可以理解为基础数据类型
 * @param promise 由then 返回的promise
 * @param x 执行成功或者失败回调函数得到的值，根据规范，该值可能是promise或者对象或者函数
 * @param resolve
 * @param reject
 */</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 如果x与当前实例promise一致，抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Chaining cycle detected for promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果x为一个CrazyPromise，</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/**
         * 如果x为一个CrazyPromise 那么可以使用递归去解析得到的新值，直到既不是对象或者函数
         */</span>
        x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果是一个对象或者函数，尝试去取其then方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!==</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> then
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 尝试获取一个对象或者函数的then方法，如果获取不到，那么可以以`e`为拒因
             * @type {function(*, *): CrazyPromise}
             */</span>
            then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
         * 如果then是一个函数，那么应该以x为then的this，尝试再去执行解析
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 做一个标记，因为不管是resolve还是reject，只有一次
             * @type {boolean}
             */</span>
            <span class="token keyword">let</span> isCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token parameter">y</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCalled<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
                    isCalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">r</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCalled<span class="token punctuation">)</span> <span class="token keyword">return</span>
                    isCalled <span class="token operator">=</span> <span class="token boolean">true</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * 如果执行then方法时抛出异常，那么以`e`为拒因reject
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isCalled<span class="token punctuation">)</span> <span class="token keyword">return</span>
                isCalled <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
        <span class="token comment">/**
         * 如果then一个函数，那么resolve结果
         */</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 如果x既不是对象也不是函数也不是promise，那么resolve结果
     */</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div></li></ul> <h2 id="验证"><a href="#验证" class="header-anchor">#</a> 验证</h2> <p>好了，”新娘“的红盖头已经揭秘了，但是，别着急哦，现在还不知道是不是你的新娘呢，万一。。。。</p> <p>所以还是检验一下是不是自己的“新娘”吧，怎么检验呢？？？</p> <p>答案那肯定是”娘家“呀，”娘家“是最了解的</p> <p>我们使用Promises/A+官方的测试工具 <a href="https://link.segmentfault.com/?enc=Dy4XykGSpZtm6%2Fy2duYmow%3D%3D.NeVIzh0rYaKoqnCjq%2FLE0AGBgip6vw5izlkUTIwFOvVrCvkAF%2BDmaL43uwzImcOIKU3qr%2F%2ByFm2yk3gerr3m0Q%3D%3D" target="_blank" rel="noopener noreferrer">promises-aplus-tests<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来对我们的<code>myPromise</code>进行测试</p> <p><strong>安装 <code>promises-aplus-tests</code>:</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> promises-aplus-tests <span class="token parameter variable">-D</span>
// 或者
<span class="token function">npm</span> <span class="token function">install</span> promises-aplus-tests <span class="token parameter variable">-g</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后，好需要在当前文件中添加以下代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>CrazyPromise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CrazyPromise<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>最后运行命令：<code>promises-aplus-tests test</code>,这里``test`是文件名称，不需要.js后缀</p> <p>可以看到，<strong>872个用例</strong>已经全部通过啦，呵呵哈哈哈<img src="https://dl4.weshineapp.com/gif/20211028/50b7d0a7a983bbac2e35a7b0e2b9080c.gif?f=micro_" alt="img"></p> <p><img src="https://oss.eqian.site/typora/image-20240828111028023.png" alt="image-20240828111028023"></p> <p><img src="https://oss.eqian.site/typora/image-20240828111012385.png" alt="image-20240828111012385"></p> <p>现在，已经证明了“新娘”是自己的“新娘”了，那么接下来。。。（此处省略99999999个字）</p> <p>那接下来就搞点其他的呗</p> <h2 id="catch方法"><a href="#catch方法" class="header-anchor">#</a> catch方法</h2> <p>catch方法不过是reject时的封装，并不属于其规范，但是，为了能够与原生的保持一致，可以实现一下吧。</p> <p>根据原生的写发，我们都知道，catch参数是一个回调方法，同时，因为是执行的失败的结果，所以，第一个参数可以设置为null,只执行失败的回调</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">/**
     * 失败的捕获方法
     * @param onRejected
     */</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/**
         * 因为是执行的失败的结果，所以，第一个参数可以设置为null,只执行失败的回调
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="静态resolve方法"><a href="#静态resolve方法" class="header-anchor">#</a> 静态resolve方法</h2> <p>在原生的写法中，我们是可以这样<code>Promise.resolve().then()</code>使用的，所以我们可以实现一个静态的方法，可以通过<code>CrazyPromise</code>直接调用，而不需要一个实例</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/**
         * 创建一个实例，并返回一个promise
         */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 判断resolve的结果是不是一个promise
             * 如果是，那么再去执行value 的then方法
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/**
             * 判断resolve的结果不是一个promise，直接resolve结果 
             */</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="静态reject方法"><a href="#静态reject方法" class="header-anchor">#</a> 静态reject方法</h2> <p>原生的写法中，我们是可以这样<code>Promise.reject().then()</code>使用的，所以我们可以实现一个静态的方法，可以通过<code>CrazyPromise</code>直接调用，而不需要一个实例</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 与静态的resolve一致，需要创建一个promise实例，并返回
         */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 这里因为是失败的结果，所以不需要再去处理，value值为promise情况
             */</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="静态all方法"><a href="#静态all方法" class="header-anchor">#</a> 静态all方法</h2> <p>这里的al方法处理起来可能会有一丢丢的麻烦</p> <ul><li>创建一个数组，保存执行的结果值</li> <li>遍历<code>promises</code>,并拿到每个promise的状态</li> <li>判断每个promise的状态是不是已成功的，如果是将promise的结果保存到数组中</li> <li>如果promise的状态是已拒绝的，那么执行reject出去</li> <li>如果没有reject的，并且拿到的结果值长度与<code>promises</code>的长度一致，说明是全部执行成功的，然后直接执行resolve，将结果的数组作为参数返回</li></ul> <p><strong>就是为什么我们在执行原生的all方法时，会得到一个数组的结果值</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">/**
     * promise 的all方法
     * @param promises
     * @return {CrazyPromise}
     */</span>
    <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/**
         * 创建一个数组保存执行结果
         * @type {*[]}
         */</span>
        <span class="token keyword">let</span> values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">/**
         * 创建一个实例并返回
         */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CrazyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 遍历promises数组，拿到每一个promise对象
             */</span>
            promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">promise</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * 判断当前状态的值是不是已成功的，如果是，将结果保存起来
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>state <span class="token operator">===</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    values<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">.</span>state <span class="token operator">===</span> CrazyPromise<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">/**
                     * 再判断当前状态的值是不是已失败的，如果是，直接reject，不处理结果
                     */</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/**
                 * 如果拿到的结果长度与promises的长度一致，说明执行成功的
                 * 将结果resolve出去，这就是为什么我们在执行原生的all方法时，会得到一个数组的结果值
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span>length <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h1 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h1> <p>好了，以上就是实现一个promise的过程，散会！！！</p> <h1 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h1> <p><a href="https://segmentfault.com/a/1190000041150227" target="_blank" rel="noopener noreferrer">javascript - 手把手一行一行代码教你 &quot;手写 Promise&quot;，完美通过 Promises/A+ 官方872个测试用例 - 个人文章 - SegmentFault 思否<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://eqian.site" target="_blank" rel="noopener noreferrer">个人网站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间: </span> <span class="time">2024-08-28, 15:40:20</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-6ea58682 data-v-58d791b2><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#promise" class="sidebar-link reco-side-promise" data-v-6ea58682>Promise</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#thenable" class="sidebar-link reco-side-thenable" data-v-6ea58682>thenable</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#值-value" class="sidebar-link reco-side-值-value" data-v-6ea58682>值（value）</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#异常-exception" class="sidebar-link reco-side-异常-exception" data-v-6ea58682>异常（exception）</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#拒因-reason" class="sidebar-link reco-side-拒因-reason" data-v-6ea58682>拒因（reason）</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#promise-的状态" class="sidebar-link reco-side-promise-的状态" data-v-6ea58682>Promise 的状态</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#等待态-pending" class="sidebar-link reco-side-等待态-pending" data-v-6ea58682>等待态（Pending）</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#执行态-fulfilled" class="sidebar-link reco-side-执行态-fulfilled" data-v-6ea58682>执行态（Fulfilled）</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#拒绝态-rejected" class="sidebar-link reco-side-拒绝态-rejected" data-v-6ea58682>拒绝态（Rejected）</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#then-方法" class="sidebar-link reco-side-then-方法" data-v-6ea58682>Then 方法</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#参数可选" class="sidebar-link reco-side-参数可选" data-v-6ea58682>参数可选</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#onfulfilled-特性" class="sidebar-link reco-side-onfulfilled-特性" data-v-6ea58682>onFulfilled 特性</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#onrejected-特性" class="sidebar-link reco-side-onrejected-特性" data-v-6ea58682>onRejected 特性</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#调用时机" class="sidebar-link reco-side-调用时机" data-v-6ea58682>调用时机</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#调用要求" class="sidebar-link reco-side-调用要求" data-v-6ea58682>调用要求</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#多次调用" class="sidebar-link reco-side-多次调用" data-v-6ea58682>多次调用</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#返回" class="sidebar-link reco-side-返回" data-v-6ea58682>返回</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#promise-解决过程" class="sidebar-link reco-side-promise-解决过程" data-v-6ea58682>Promise 解决过程</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#x-与-promise-相等" class="sidebar-link reco-side-x-与-promise-相等" data-v-6ea58682>x 与 promise 相等</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#x-为-promise" class="sidebar-link reco-side-x-为-promise" data-v-6ea58682>x 为 Promise</a></li><li class="level-3" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#x-为对象或函数" class="sidebar-link reco-side-x-为对象或函数" data-v-6ea58682>x 为对象或函数</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#创建promise实例" class="sidebar-link reco-side-创建promise实例" data-v-6ea58682>创建promise实例</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#resolve方法" class="sidebar-link reco-side-resolve方法" data-v-6ea58682>resolve方法</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#reject方法" class="sidebar-link reco-side-reject方法" data-v-6ea58682>reject方法</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#then方法" class="sidebar-link reco-side-then方法" data-v-6ea58682>then方法</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#验证" class="sidebar-link reco-side-验证" data-v-6ea58682>验证</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#catch方法" class="sidebar-link reco-side-catch方法" data-v-6ea58682>catch方法</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#静态resolve方法" class="sidebar-link reco-side-静态resolve方法" data-v-6ea58682>静态resolve方法</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#静态reject方法" class="sidebar-link reco-side-静态reject方法" data-v-6ea58682>静态reject方法</a></li><li class="level-2" data-v-6ea58682><a href="/cz-docs/blogs/JavaScript/%E6%8F%AD%E5%BC%80Promise%E7%A5%9E%E7%A7%98%E7%9A%84%E9%9D%A2%E7%BA%B1.html#静态all方法" class="sidebar-link reco-side-静态all方法" data-v-6ea58682>静态all方法</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><canvas id="vuepress-canvas-cursor"></canvas><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      我是lookroot欢迎你的关注 
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="300px" height="352" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><!----><div></div><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="http://music.163.com/song/media/outer/url?id=518291899.mp3" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:200px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="https://p1.music.126.net/AKhQSRL6HyZu4YwWg4Wi6A==/109951163060585255.jpg?param=130y130" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(https://p1.music.126.net/AKhQSRL6HyZu4YwWg4Wi6A==/109951163060585255.jpg?param=130y130);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>飞舞吧，樱花！</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>余日秋山</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div><!----></div></div>
    <script src="/cz-docs/assets/js/app.e0426d90.js" defer></script><script src="/cz-docs/assets/js/4.f75cd3a5.js" defer></script><script src="/cz-docs/assets/js/1.0d7da4e9.js" defer></script><script src="/cz-docs/assets/js/17.6c17d3eb.js" defer></script><script src="/cz-docs/assets/js/11.a973ada2.js" defer></script>
  </body>
</html>
